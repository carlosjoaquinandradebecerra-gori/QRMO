<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recompensas QRMO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Estilos propios -->
  <link rel="stylesheet" href="styles.css">

  <!-- Ethers v6 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
</head>

<body class="bg-dark text-white recompensas-page">

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-black">
  <div class="container">
    <a href="#" onclick="history.back(); return false;" class="navbar-brand">
      ‚¨Ö Volver
    </a>
  </div>
</nav>

<!-- CONTENIDO -->
<section class="py-5">
  <div class="container">

    <h2 class="text-center mb-4">üéÅ Recompensas QRMO</h2>

    <!-- CONTRATO -->
    <div class="alert alert-dark text-center">
      <strong>Contrato:</strong>
      <span id="caddr">‚Äî</span>
    </div>

    <!-- CONECTAR -->
    <div class="card bg-secondary text-white p-4 mb-3">
      <h5>1Ô∏è‚É£ Conectar MetaMask</h5>
      <button id="btnConnect" class="btn btn-primary me-2">Conectar</button>
      <button id="btnSwitch" class="btn btn-outline-light">Cambiar a Sepolia</button>

      <p class="mt-3">Cuenta: <span id="account">‚Äî</span></p>
      <p>Red: <span id="network">‚Äî</span></p>
      <p>Estado: <span id="status">Esperando conexi√≥n‚Ä¶</span></p>
    </div>

    <!-- BALANCE -->
    <div class="card bg-secondary text-white p-4 mb-3">
      <h5>2Ô∏è‚É£ Mi balance</h5>
      <button id="btnBalance" class="btn btn-success" disabled>Ver balance</button>
      <p class="mt-2">Balance: <span id="balance">‚Äî</span></p>
    </div>

    <!-- ENVIAR -->
    <div class="card bg-secondary text-white p-4">
      <h5>3Ô∏è‚É£ Enviar QRMO</h5>
      <input id="to" class="form-control mb-2" placeholder="Direcci√≥n destino 0x..." />
      <input id="amount" class="form-control mb-2" placeholder="Cantidad QRMO" />
      <button id="btnSend" class="btn btn-warning" disabled>Enviar QRMO</button>
      <p class="mt-2">Tx: <span id="tx">‚Äî</span></p>
    </div>

  </div>
</section>

<!-- SCRIPT -->
<script>
  // ================= CONFIGURACI√ìN =================
  const CONTRACT_ADDRESS = "0x0e54f23dff43ff979150548a3473e02474dc9e7d"; // tu contrato Sepolia
  const SEPOLIA_CHAIN_ID = "0xaa36a7";

  const ABI = [
    "function balanceOf(address owner) view returns (uint256)",
    "function transfer(address to, uint256 amount) returns (bool)",
    "function decimals() view returns (uint8)",
    "function symbol() view returns (string)"
  ];

  // ================= UI =================
  const elAccount = document.getElementById("account");
  const elNetwork = document.getElementById("network");
  const elStatus  = document.getElementById("status");
  const elBal     = document.getElementById("balance");
  const elTx      = document.getElementById("tx");
  const elCaddr   = document.getElementById("caddr");

  elCaddr.textContent = CONTRACT_ADDRESS;

  const btnConnect = document.getElementById("btnConnect");
  const btnSwitch  = document.getElementById("btnSwitch");
  const btnBalance = document.getElementById("btnBalance");
  const btnSend    = document.getElementById("btnSend");

  let provider, signer, userAddress, token;
  let decimals = 18;
  let symbol = "TOKEN";

  function setStatus(msg, ok = true) {
    elStatus.textContent = msg;
    elStatus.className = ok ? "text-success" : "text-danger";
  }

  function requireMetaMask() {
    if (!window.ethereum) {
      setStatus("MetaMask no detectado. Inst√°lalo o usa un navegador compatible.", false);
      throw new Error("No MetaMask");
    }
  }

  async function refreshNetworkLabel() {
    const net = await provider.getNetwork();
    elNetwork.textContent = `${net.name} (chainId: ${net.chainId})`;
    return net;
  }

  async function connect() {
    try {
      requireMetaMask();

      await window.ethereum.request({ method: "eth_requestAccounts" });

      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      userAddress = await signer.getAddress();
      elAccount.textContent = userAddress;

      const net = await refreshNetworkLabel();

      token = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

      try { decimals = await token.decimals(); } catch {}
      try { symbol = await token.symbol(); } catch {}

      btnBalance.disabled = false;
      btnSend.disabled = false;

      if (net.chainId !== 11155111n) {
        setStatus("Conectado, pero NO est√°s en Sepolia. Cambia la red.", false);
      } else {
        setStatus(`Conectado ‚úÖ Token ${symbol} listo`);
      }
    } catch (e) {
      console.error(e);
      setStatus("Error al conectar con MetaMask.", false);
    }
  }

  async function switchToSepolia() {
    try {
      requireMetaMask();
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: SEPOLIA_CHAIN_ID }]
      });
      if (provider) await refreshNetworkLabel();
      setStatus("Red cambiada a Sepolia ‚úÖ");
    } catch (e) {
      setStatus("No se pudo cambiar a Sepolia.", false);
    }
  }

  async function readBalance() {
    if (!token || !userAddress) return;
    const raw = await token.balanceOf(userAddress);
    elBal.textContent = `${ethers.formatUnits(raw, decimals)} ${symbol}`;
    setStatus("Balance le√≠do ‚úÖ");
  }

  async function send() {
    const to = document.getElementById("to").value.trim();
    const amount = document.getElementById("amount").value.trim();

    if (!to || !amount) {
      setStatus("Falta direcci√≥n o cantidad.", false);
      return;
    }

    try {
      const value = ethers.parseUnits(amount, decimals);
      setStatus("Confirma la transacci√≥n en MetaMask‚Ä¶");
      const tx = await token.transfer(to, value);
      elTx.textContent = tx.hash;
      await tx.wait();
      setStatus("Transacci√≥n confirmada ‚úÖ");
      readBalance();
    } catch (e) {
      setStatus("Transacci√≥n fallida o cancelada.", false);
    }
  }

  if (window.ethereum) {
    window.ethereum.on("accountsChanged", () => location.reload());
    window.ethereum.on("chainChanged", () => location.reload());
  }

  btnConnect.onclick = connect;
  btnSwitch.onclick  = switchToSepolia;
  btnBalance.onclick = readBalance;
  btnSend.onclick    = send;
</script>

</body>
</html>

